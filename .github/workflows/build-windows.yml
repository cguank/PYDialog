name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Create build directory
      run: |
        mkdir -p build
        mkdir -p dist
        
    - name: Build executable
      run: |
        pyinstaller --onefile --console --add-data "imgs;imgs" --add-data "utils.py;." --hidden-import cv2 --hidden-import pyautogui --hidden-import numpy --hidden-import PIL --hidden-import PIL._tkinter_finder --hidden-import tkinter --hidden-import pyscreeze --hidden-import pytweening --hidden-import mouseinfo --hidden-import keyboard --hidden-import pygetwindow --hidden-import pyrect --name dialog_handler dialog_handler.py
        
    - name: Create README for distribution
      run: |
        echo "å¼¹çª—å¤„ç†ç¨‹åº - Windowsç‰ˆæœ¬" > dist/README.txt
        echo. >> dist/README.txt
        echo "ä½¿ç”¨è¯´æ˜Ž:" >> dist/README.txt
        echo "1. åŒå‡» dialog_handler.exe è¿è¡Œç¨‹åº" >> dist/README.txt
        echo "2. ç¨‹åºä¼šè‡ªåŠ¨ç›‘æŽ§å±å¹•ä¸Šçš„å¼¹çª—" >> dist/README.txt
        echo "3. æŒ‰ Ctrl+C åœæ­¢ç¨‹åº" >> dist/README.txt
        echo. >> dist/README.txt
        echo "æ³¨æ„äº‹é¡¹:" >> dist/README.txt
        echo "- ç¡®ä¿ imgs æ–‡ä»¶å¤¹ä¸Ž exe æ–‡ä»¶åœ¨åŒä¸€ç›®å½•" >> dist/README.txt
        echo "- ç¨‹åºéœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è¿›è¡Œå±å¹•æˆªå›¾" >> dist/README.txt
        echo "- å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™è®¾ç½®" >> dist/README.txt
        echo. >> dist/README.txt
        echo "æ–‡ä»¶ç»“æž„:" >> dist/README.txt
        echo "dialog_handler.exe  - ä¸»ç¨‹åº" >> dist/README.txt
        echo "imgs/              - å¼¹çª—æ¨¡æ¿å›¾ç‰‡æ–‡ä»¶å¤¹" >> dist/README.txt
        
    - name: Get file size
      id: file_size
      run: |
        $size = (Get-Item "dist/dialog_handler.exe").Length
        $sizeMB = [math]::Round($size / 1MB, 2)
        echo "size=$sizeMB" >> $env:GITHUB_OUTPUT
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dialog-handler-windows
        path: |
          dist/dialog_handler.exe
          dist/imgs/
          dist/README.txt
        retention-days: 30
        
    - name: Create release assets (on release)
      if: github.event_name == 'release'
      run: |
        # åˆ›å»ºZIPæ–‡ä»¶
        Compress-Archive -Path "dist/*" -DestinationPath "dialog_handler_windows.zip"
        
    - name: Upload release assets (on release)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./dialog_handler_windows.zip
        asset_name: dialog_handler_windows.zip
        asset_content_type: application/zip
        
    - name: Build summary
      run: |
        echo "## ðŸŽ‰ æž„å»ºæˆåŠŸ!" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **dialog_handler.exe** - Windowså¯æ‰§è¡Œæ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
        echo "- **imgs/** - å¼¹çª—æ¨¡æ¿å›¾ç‰‡æ–‡ä»¶å¤¹" >> $env:GITHUB_STEP_SUMMARY
        echo "- **README.txt** - ä½¿ç”¨è¯´æ˜Ž" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æ–‡ä»¶ä¿¡æ¯:" >> $env:GITHUB_STEP_SUMMARY
        echo "- å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: ${{ steps.file_size.outputs.size }} MB" >> $env:GITHUB_STEP_SUMMARY
        echo "- æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸš€ éƒ¨ç½²è¯´æ˜Ž:" >> $env:GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½æž„å»ºäº§ç‰©" >> $env:GITHUB_STEP_SUMMARY
        echo "2. è§£åŽ‹åˆ°ç›®æ ‡Windowsæœºå™¨" >> $env:GITHUB_STEP_SUMMARY
        echo "3. ç¡®ä¿imgsæ–‡ä»¶å¤¹åŒ…å«å¼¹çª—æ¨¡æ¿å›¾ç‰‡" >> $env:GITHUB_STEP_SUMMARY
        echo "4. åŒå‡»dialog_handler.exeè¿è¡Œç¨‹åº" >> $env:GITHUB_STEP_SUMMARY 